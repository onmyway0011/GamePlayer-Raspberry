FROM python:3.9-slim

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV TEST_ENV=true
ENV DOCKER_ENV=true
ENV DISPLAY=:1
ENV VNC_PORT=5901
ENV NOVNC_PORT=6080

# å®‰è£…åŸºç¡€ä¾èµ–å’Œå›¾å½¢ç•Œé¢ç»„ä»¶
RUN apt-get update && apt-get install -y \
    # åŸºç¡€å·¥å…·
    git wget curl build-essential \
    # X11 å’Œå›¾å½¢ç•Œé¢
    xvfb x11vnc fluxbox \
    # VNC å’Œ noVNC
    tigervnc-standalone-server tigervnc-common \
    # æ¸¸æˆå’Œæ¨¡æ‹Ÿå™¨ä¾èµ–
    libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
    libgl1-mesa-dev libglu1-mesa-dev \
    # éŸ³é¢‘æ”¯æŒ
    pulseaudio alsa-utils \
    # å­—ä½“æ”¯æŒ
    fonts-dejavu-core fonts-liberation \
    # ç½‘ç»œå·¥å…·
    net-tools procps \
    # æ–‡ä»¶ç®¡ç†
    mc nano vim \
    # æµè§ˆå™¨ (ç”¨äºæµ‹è¯•)
    firefox-esr \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£… noVNC (Web VNC å®¢æˆ·ç«¯)
RUN cd /opt && \
    git clone https://github.com/novnc/noVNC.git && \
    git clone https://github.com/novnc/websockify.git && \
    ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html

# åˆ›å»ºå·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY . /app/

# å‡çº§ pip å¹¶å®‰è£… Python ä¾èµ–
RUN pip install --upgrade pip && \
    pip install requests paramiko tqdm flask pytest pytest-cov pytest-asyncio pytest-mock \
    pillow pyyaml psutil python-dotenv pygame

# åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
RUN mkdir -p \
    /opt/retropie/emulators/nesticle \
    /opt/retropie/configs/nes \
    /home/pi/RetroPie/roms/nes \
    /home/pi/RetroPie/cheats \
    /home/pi/RetroPie/saves/nes \
    /usr/share/applications \
    /etc/systemd/system \
    /root/.vnc \
    /tmp/.X11-unix

# è®¾ç½® VNC å¯†ç 
RUN mkdir -p /root/.vnc && \
    echo "gameplayer" | vncpasswd -f > /root/.vnc/passwd && \
    chmod 600 /root/.vnc/passwd

# åˆ›å»º VNC å¯åŠ¨é…ç½®
RUN echo '#!/bin/bash\n\
export DISPLAY=:1\n\
Xvfb :1 -screen 0 1024x768x24 &\n\
sleep 2\n\
fluxbox &\n\
x11vnc -display :1 -nopw -listen localhost -xkb -ncache 10 -ncache_cr -forever &\n\
' > /usr/local/bin/start-vnc.sh && \
    chmod +x /usr/local/bin/start-vnc.sh

# åˆ›å»ºæ¸¸æˆå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash\n\
export DISPLAY=:1\n\
cd /app\n\
echo "ğŸ® å¯åŠ¨æ¸¸æˆç¯å¢ƒ..."\n\
echo "VNC è®¿é—®: http://localhost:6080/vnc.html"\n\
echo "ç›´æ¥ VNC: localhost:5901 (å¯†ç : gameplayer)"\n\
python3 -c "\n\
import pygame\n\
import sys\n\
import time\n\
\n\
print(\"ğŸ® åˆå§‹åŒ– Pygame...\")\n\
pygame.init()\n\
\n\
# åˆ›å»ºæ¸¸æˆçª—å£\n\
screen = pygame.display.set_mode((800, 600))\n\
pygame.display.set_caption(\"GamePlayer-Raspberry Demo\")\n\
\n\
# é¢œè‰²å®šä¹‰\n\
BLACK = (0, 0, 0)\n\
WHITE = (255, 255, 255)\n\
RED = (255, 0, 0)\n\
GREEN = (0, 255, 0)\n\
BLUE = (0, 0, 255)\n\
\n\
# æ¸¸æˆå¾ªç¯\n\
clock = pygame.time.Clock()\n\
running = True\n\
x, y = 400, 300\n\
dx, dy = 2, 2\n\
\n\
print(\"ğŸ® æ¸¸æˆå¼€å§‹! æŒ‰ ESC é€€å‡º\")\n\
\n\
while running:\n\
    for event in pygame.event.get():\n\
        if event.type == pygame.QUIT:\n\
            running = False\n\
        elif event.type == pygame.KEYDOWN:\n\
            if event.key == pygame.K_ESCAPE:\n\
                running = False\n\
    \n\
    # æ›´æ–°çƒçš„ä½ç½®\n\
    x += dx\n\
    y += dy\n\
    \n\
    # è¾¹ç•Œæ£€æµ‹\n\
    if x <= 0 or x >= 780:\n\
        dx = -dx\n\
    if y <= 0 or y >= 580:\n\
        dy = -dy\n\
    \n\
    # ç»˜åˆ¶\n\
    screen.fill(BLACK)\n\
    pygame.draw.circle(screen, RED, (int(x), int(y)), 20)\n\
    \n\
    # ç»˜åˆ¶æ–‡å­—\n\
    font = pygame.font.Font(None, 36)\n\
    text = font.render(\"GamePlayer-Raspberry Demo\", True, WHITE)\n\
    screen.blit(text, (200, 50))\n\
    \n\
    text2 = font.render(\"Press ESC to exit\", True, GREEN)\n\
    screen.blit(text2, (280, 500))\n\
    \n\
    pygame.display.flip()\n\
    clock.tick(60)\n\
\n\
pygame.quit()\n\
print(\"ğŸ® æ¸¸æˆç»“æŸ!\")\n\
"\n\
' > /usr/local/bin/start-game.sh && \
    chmod +x /usr/local/bin/start-game.sh

# è®¾ç½®æƒé™
RUN chmod +x scripts/*.sh || true

# æš´éœ²ç«¯å£
EXPOSE 8080 5901 6080

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash\n\
echo "ğŸš€ å¯åŠ¨ GamePlayer-Raspberry GUI ç¯å¢ƒ..."\n\
\n\
# å¯åŠ¨ Xvfb\n\
echo "ğŸ“º å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤º..."\n\
Xvfb :1 -screen 0 1024x768x24 &\n\
sleep 2\n\
\n\
# å¯åŠ¨çª—å£ç®¡ç†å™¨\n\
echo "ğŸ–¼ï¸ å¯åŠ¨çª—å£ç®¡ç†å™¨..."\n\
export DISPLAY=:1\n\
fluxbox &\n\
sleep 1\n\
\n\
# å¯åŠ¨ VNC æœåŠ¡å™¨\n\
echo "ğŸ”— å¯åŠ¨ VNC æœåŠ¡å™¨..."\n\
x11vnc -display :1 -nopw -listen 0.0.0.0 -xkb -ncache 10 -ncache_cr -forever -rfbport 5901 &\n\
sleep 2\n\
\n\
# å¯åŠ¨ noVNC\n\
echo "ğŸŒ å¯åŠ¨ Web VNC (noVNC)..."\n\
cd /opt/noVNC\n\
./utils/launch.sh --vnc localhost:5901 --listen 6080 &\n\
sleep 2\n\
\n\
# å¯åŠ¨ HTTP æœåŠ¡å™¨\n\
echo "ğŸŒ å¯åŠ¨ HTTP æœåŠ¡å™¨..."\n\
cd /app\n\
python3 -c "\n\
import http.server\n\
import socketserver\n\
import threading\n\
import time\n\
\n\
PORT = 8080\n\
Handler = http.server.SimpleHTTPRequestHandler\n\
\n\
def start_server():\n\
    with socketserver.TCPServer((\"\", PORT), Handler) as httpd:\n\
        print(f\"HTTP æœåŠ¡å™¨å¯åŠ¨åœ¨ç«¯å£ {PORT}\")\n\
        httpd.serve_forever()\n\
\n\
# åœ¨åå°å¯åŠ¨ HTTP æœåŠ¡å™¨\n\
server_thread = threading.Thread(target=start_server, daemon=True)\n\
server_thread.start()\n\
\n\
print(\"\")\n\
print(\"ğŸ‰ GamePlayer-Raspberry GUI ç¯å¢ƒå¯åŠ¨å®Œæˆ!\")\n\
print(\"\")\n\
print(\"ğŸ“± è®¿é—®æ–¹å¼:\")\n\
print(\"  ğŸŒ Web VNC: http://localhost:6080/vnc.html\")\n\
print(\"  ğŸ”— ç›´æ¥ VNC: localhost:5901 (å¯†ç : gameplayer)\")\n\
print(\"  ğŸ“ æ–‡ä»¶æµè§ˆ: http://localhost:8080\")\n\
print(\"\")\n\
print(\"ğŸ® æ¸¸æˆå‘½ä»¤:\")\n\
print(\"  å¯åŠ¨æ¼”ç¤ºæ¸¸æˆ: docker exec <container> /usr/local/bin/start-game.sh\")\n\
print(\"  è¿è¡Œæµ‹è¯•: docker exec <container> python3 -m pytest tests/ -v\")\n\
print(\"\")\n\
print(\"âŒ¨ï¸ æŒ‰ Ctrl+C åœæ­¢æœåŠ¡\")\n\
\n\
try:\n\
    while True:\n\
        time.sleep(1)\n\
except KeyboardInterrupt:\n\
    print(\"\\nğŸ‘‹ æœåŠ¡åœæ­¢\")\n\
" &\n\
\n\
# ç­‰å¾…æ‰€æœ‰æœåŠ¡å¯åŠ¨\n\
wait\n\
' > /usr/local/bin/start-all.sh && \
    chmod +x /usr/local/bin/start-all.sh

# å¯åŠ¨å‘½ä»¤
CMD ["/usr/local/bin/start-all.sh"]
