# GamePlayer-Raspberry æ ‘è“æ´¾é•œåƒ
# åŸºäºå®˜æ–¹æ ‘è“æ´¾OSé•œåƒ

FROM balenalib/raspberry-pi-debian:bullseye

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONPATH=/opt/gameplayer
ENV HOME=/home/pi
ENV USER=pi

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    # Pythonç¯å¢ƒ
    python3 python3-pip python3-dev python3-venv \
    # æ¸¸æˆç›¸å…³åº“
    libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
    # éŸ³é¢‘æ”¯æŒ
    pulseaudio alsa-utils \
    # å›¾å½¢ç•Œé¢
    xorg openbox lightdm \
    # ç½‘ç»œå·¥å…·
    curl wget git \
    # ç³»ç»Ÿå·¥å…·
    sudo htop vim nano \
    # ç¼–è¯‘å·¥å…·
    build-essential cmake pkg-config \
    # æ–‡ä»¶å·¥å…·
    unzip p7zip-full \
    # è“ç‰™æ”¯æŒ
    bluetooth bluez bluez-tools \
    # USBæ”¯æŒ
    usbutils \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºpiç”¨æˆ·
RUN useradd -m -s /bin/bash pi && \
    echo "pi:raspberry" | chpasswd && \
    usermod -aG sudo,audio,video,input,bluetooth pi && \
    echo "pi ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# åˆ‡æ¢åˆ°piç”¨æˆ·
USER pi
WORKDIR /home/pi

# åˆ›å»ºé¡¹ç›®ç›®å½•
RUN mkdir -p /home/pi/GamePlayer-Raspberry

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY --chown=pi:pi . /home/pi/GamePlayer-Raspberry/

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /home/pi/GamePlayer-Raspberry

# å®‰è£…Pythonä¾èµ–
RUN pip3 install --user -r requirements.txt

# åˆ›å»ºROMç›®å½•ç»“æ„
RUN mkdir -p data/roms/{nes,snes,gameboy,gba,genesis,psx,n64,arcade} && \
    mkdir -p data/saves/{nes,snes,gameboy,gba,genesis,psx,n64,arcade} && \
    mkdir -p logs

# ä¸‹è½½ROMæ–‡ä»¶
RUN python3 src/scripts/download_roms.py

# è®¾ç½®æƒé™
RUN chmod +x src/scripts/*.sh src/scripts/*.py

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash\n\
echo "ğŸ“ GamePlayer-Raspberry å¯åŠ¨ä¸­..."\n\
\n\
# å¯åŠ¨éŸ³é¢‘æœåŠ¡\n\
pulseaudio --start --log-target=syslog\n\
\n\
# å¯åŠ¨è“ç‰™æœåŠ¡\n\
sudo systemctl start bluetooth\n\
\n\
# å¯åŠ¨æ¸¸æˆç³»ç»Ÿ\n\
cd /home/pi/GamePlayer-Raspberry\n\
python3 src/scripts/enhanced_game_launcher.py --web-only --port 3000\n\
' > /home/pi/start_gameplayer.sh && \
    chmod +x /home/pi/start_gameplayer.sh

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨å‘½ä»¤
CMD ["/home/pi/start_gameplayer.sh"]