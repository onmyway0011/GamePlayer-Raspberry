# æ ‘è“æ´¾æ¨¡æ‹Ÿç¯å¢ƒ Dockerfile
# åŸºäºARM64æ¶æ„æ¨¡æ‹Ÿæ ‘è“æ´¾ç¯å¢ƒ

FROM arm64v8/ubuntu:22.04

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV DEBIAN_FRONTEND=noninteractive
ENV DISPLAY=:1
ENV HOME=/home/pi
ENV USER=pi

# å®‰è£…åŸºç¡€åŒ…
RUN apt-get update && apt-get install -y \
    # ç³»ç»Ÿå·¥å…·
    sudo curl wget git vim nano htop \
    # Pythonç¯å¢ƒ
    python3 python3-pip python3-dev \
    # å›¾å½¢ç•Œé¢
    xvfb fluxbox x11vnc novnc websockify \
    # éŸ³é¢‘æ”¯æŒ
    pulseaudio alsa-utils \
    # æ¸¸æˆç›¸å…³
    libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev \
    # ç¼–è¯‘å·¥å…·
    build-essential cmake pkg-config \
    # ç½‘ç»œå·¥å…·
    net-tools iputils-ping \
    # æ–‡ä»¶å·¥å…·
    unzip p7zip-full \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºpiç”¨æˆ·ï¼ˆæ¨¡æ‹Ÿæ ‘è“æ´¾é»˜è®¤ç”¨æˆ·ï¼‰
RUN useradd -m -s /bin/bash pi && \
    echo "pi:raspberry" | chpasswd && \
    usermod -aG sudo pi && \
    echo "pi ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# åˆ‡æ¢åˆ°piç”¨æˆ·
USER pi
WORKDIR /home/pi

# åˆ›å»ºæ ‘è“æ´¾ç›®å½•ç»“æ„
RUN mkdir -p /home/pi/RetroPie/roms/nes && \
    mkdir -p /home/pi/RetroPie/configs && \
    mkdir -p /home/pi/RetroPie/emulators && \
    mkdir -p /home/pi/GamePlayer-Raspberry && \
    mkdir -p /home/pi/.config

# å®‰è£…PythonåŒ…
RUN pip3 install --user \
    pygame \
    requests \
    flask \
    pillow \
    pyyaml \
    psutil \
    tqdm \
    numpy

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY --chown=pi:pi . /home/pi/GamePlayer-Raspberry/

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /home/pi/GamePlayer-Raspberry

# å®‰è£…é¡¹ç›®ä¾èµ–
RUN pip3 install --user -r requirements.txt

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash\n\
echo "ğŸš€ å¯åŠ¨æ ‘è“æ´¾æ¨¡æ‹Ÿç¯å¢ƒ..."\n\
\n\
# å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤º\n\
Xvfb :1 -screen 0 1024x768x24 &\n\
sleep 3\n\
\n\
# å¯åŠ¨çª—å£ç®¡ç†å™¨\n\
export DISPLAY=:1\n\
fluxbox &\n\
sleep 2\n\
\n\
# å¯åŠ¨VNCæœåŠ¡å™¨\n\
x11vnc -display :1 -nopw -listen 0.0.0.0 -xkb -ncache 10 -ncache_cr -forever -rfbport 5901 &\n\
sleep 3\n\
\n\
# å¯åŠ¨noVNC\n\
cd /usr/share/novnc\n\
./utils/launch.sh --vnc localhost:5901 --listen 6080 &\n\
sleep 3\n\
\n\
# å¯åŠ¨HTTPæœåŠ¡å™¨\n\
cd /home/pi/GamePlayer-Raspberry\n\
python3 -m http.server 8080 &\n\
\n\
echo "âœ… æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨"\n\
echo "ğŸ“± VNCè®¿é—®: http://localhost:6080/vnc.html"\n\
echo "ğŸ“ æ–‡ä»¶è®¿é—®: http://localhost:8080"\n\
echo "ğŸ® å¼€å§‹ä¸‹è½½ROMæ–‡ä»¶..."\n\
\n\
# ä¸‹è½½ROMæ–‡ä»¶\n\
python3 scripts/rom_downloader.py --output /home/pi/RetroPie/roms/nes\n\
\n\
echo "ğŸ‰ æ ‘è“æ´¾æ¨¡æ‹Ÿç¯å¢ƒå°±ç»ªï¼"\n\
\n\
# ä¿æŒå®¹å™¨è¿è¡Œ\n\
tail -f /dev/null\n\
' > /home/pi/start-raspberry-sim.sh && chmod +x /home/pi/start-raspberry-sim.sh

# åˆ›å»ºNESæ¨¡æ‹Ÿå™¨å¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash\n\
echo "ğŸ® å¯åŠ¨NESæ¸¸æˆæ¨¡æ‹Ÿå™¨..."\n\
\n\
export DISPLAY=:1\n\
cd /home/pi/GamePlayer-Raspberry\n\
\n\
# æ£€æŸ¥ROMæ–‡ä»¶\n\
ROM_DIR="/home/pi/RetroPie/roms/nes"\n\
if [ ! -d "$ROM_DIR" ] || [ -z "$(ls -A $ROM_DIR/*.nes 2>/dev/null)" ]; then\n\
    echo "ğŸ“¥ ä¸‹è½½ROMæ–‡ä»¶..."\n\
    python3 scripts/rom_downloader.py --output "$ROM_DIR"\n\
fi\n\
\n\
# åˆ—å‡ºå¯ç”¨æ¨¡æ‹Ÿå™¨\n\
echo "ğŸ® å¯ç”¨æ¨¡æ‹Ÿå™¨:"\n\
python3 scripts/run_nes_game.py --list-emulators\n\
\n\
# åˆ—å‡ºå¯ç”¨ROM\n\
echo "ğŸ“‹ å¯ç”¨æ¸¸æˆ:"\n\
python3 scripts/rom_manager.py --roms-dir "$ROM_DIR" list\n\
\n\
# å¯åŠ¨æ¸¸æˆé€‰æ‹©ç•Œé¢\n\
echo "ğŸš€ å¯åŠ¨æ¸¸æˆé€‰æ‹©ç•Œé¢..."\n\
python3 scripts/nes_game_launcher.py --roms-dir "$ROM_DIR"\n\
' > /home/pi/start-nes-games.sh && chmod +x /home/pi/start-nes-games.sh

# åˆ›å»ºRetroPieé…ç½®æ–‡ä»¶
RUN echo '# RetroPie é…ç½®æ–‡ä»¶\n\
[nes]\n\
emulator = "nesticle"\n\
rom_path = "/home/pi/RetroPie/roms/nes"\n\
save_path = "/home/pi/RetroPie/saves/nes"\n\
\n\
[nesticle]\n\
executable = "/home/pi/GamePlayer-Raspberry/core/nesticle_installer.py"\n\
config_file = "/home/pi/RetroPie/configs/nes/nesticle.cfg"\n\
\n\
[virtuanes]\n\
executable = "/home/pi/GamePlayer-Raspberry/core/virtuanes_installer.py"\n\
config_file = "/home/pi/RetroPie/configs/nes/virtuanes.cfg"\n\
' > /home/pi/RetroPie/configs/retropie.conf

# æš´éœ²ç«¯å£
EXPOSE 5901 6080 8080

# è®¾ç½®å¯åŠ¨å‘½ä»¤
CMD ["/home/pi/start-raspberry-sim.sh"]
