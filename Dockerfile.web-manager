# Webç®¡ç†ç•Œé¢ Dockerfile
FROM node:18-alpine

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache \
    python3 \
    py3-pip \
    curl \
    bash

# åˆ›å»ºWebç®¡ç†ç•Œé¢
RUN mkdir -p public static templates

# åˆ›å»ºpackage.json
RUN echo '{\
  "name": "gameplayer-web-manager",\
  "version": "1.0.0",\
  "description": "GamePlayer-Raspberry Webç®¡ç†ç•Œé¢",\
  "main": "server.js",\
  "scripts": {\
    "start": "node server.js",\
    "dev": "nodemon server.js"\
  },\
  "dependencies": {\
    "express": "^4.18.2",\
    "socket.io": "^4.7.2",\
    "multer": "^1.4.5",\
    "cors": "^2.8.5",\
    "axios": "^1.4.0"\
  }\
}' > package.json

# å®‰è£…Node.jsä¾èµ–
RUN npm install

# åˆ›å»ºæœåŠ¡å™¨æ–‡ä»¶
RUN echo 'const express = require("express");\
const http = require("http");\
const socketIo = require("socket.io");\
const path = require("path");\
const fs = require("fs");\
const multer = require("multer");\
const cors = require("cors");\
const axios = require("axios");\
\
const app = express();\
const server = http.createServer(app);\
const io = socketIo(server, {\
  cors: {\
    origin: "*",\
    methods: ["GET", "POST"]\
  }\
});\
\
// ä¸­é—´ä»¶\
app.use(cors());\
app.use(express.json());\
app.use(express.static("public"));\
\
// æ–‡ä»¶ä¸Šä¼ é…ç½®\
const storage = multer.diskStorage({\
  destination: (req, file, cb) => {\
    cb(null, "/app/roms/");\
  },\
  filename: (req, file, cb) => {\
    cb(null, file.originalname);\
  }\
});\
const upload = multer({ storage });\
\
// è·¯ç”±\
app.get("/", (req, res) => {\
  res.sendFile(path.join(__dirname, "public", "index.html"));\
});\
\
// APIè·¯ç”±\
app.get("/api/roms", (req, res) => {\
  try {\
    const romsDir = "/app/roms";\
    const files = fs.readdirSync(romsDir)\
      .filter(file => file.endsWith(".nes"))\
      .map(file => ({\
        name: file,\
        size: fs.statSync(path.join(romsDir, file)).size,\
        modified: fs.statSync(path.join(romsDir, file)).mtime\
      }));\
    res.json(files);\
  } catch (error) {\
    res.status(500).json({ error: error.message });\
  }\
});\
\
app.post("/api/upload", upload.single("rom"), (req, res) => {\
  if (!req.file) {\
    return res.status(400).json({ error: "æ²¡æœ‰ä¸Šä¼ æ–‡ä»¶" });\
  }\
  res.json({ message: "ROMæ–‡ä»¶ä¸Šä¼ æˆåŠŸ", filename: req.file.filename });\
});\
\
app.delete("/api/roms/:filename", (req, res) => {\
  try {\
    const filename = req.params.filename;\
    const filePath = path.join("/app/roms", filename);\
    fs.unlinkSync(filePath);\
    res.json({ message: "ROMæ–‡ä»¶åˆ é™¤æˆåŠŸ" });\
  } catch (error) {\
    res.status(500).json({ error: error.message });\
  }\
});\
\
// Socket.IOè¿æ¥\
io.on("connection", (socket) => {\
  console.log("å®¢æˆ·ç«¯å·²è¿æ¥");\
  \
  socket.on("disconnect", () => {\
    console.log("å®¢æˆ·ç«¯å·²æ–­å¼€");\
  });\
});\
\
const PORT = process.env.PORT || 3000;\
server.listen(PORT, () => {\
  console.log(`Webç®¡ç†ç•Œé¢è¿è¡Œåœ¨ç«¯å£ ${PORT}`);\
});' > server.js

# åˆ›å»ºHTMLç•Œé¢
RUN echo '<!DOCTYPE html>\
<html lang="zh-CN">\
<head>\
    <meta charset="UTF-8">\
    <meta name="viewport" content="width=device-width, initial-scale=1.0">\
    <title>GamePlayer-Raspberry ç®¡ç†ç•Œé¢</title>\
    <style>\
        * { margin: 0; padding: 0; box-sizing: border-box; }\
        body { font-family: Arial, sans-serif; background: #f0f0f0; }\
        .header { background: #2c3e50; color: white; padding: 1rem; text-align: center; }\
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }\
        .card { background: white; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }\
        .btn { background: #3498db; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }\
        .btn:hover { background: #2980b9; }\
        .btn-danger { background: #e74c3c; }\
        .btn-danger:hover { background: #c0392b; }\
        .rom-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }\
        .rom-item { border: 1px solid #ddd; border-radius: 4px; padding: 1rem; }\
        .upload-area { border: 2px dashed #ddd; border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; }\
        .upload-area:hover { border-color: #3498db; }\
        .vnc-frame { width: 100%; height: 600px; border: none; border-radius: 8px; }\
    </style>\
</head>\
<body>\
    <div class="header">\
        <h1>ğŸ® GamePlayer-Raspberry ç®¡ç†ç•Œé¢</h1>\
        <p>æ ‘è“æ´¾NESæ¸¸æˆæ¨¡æ‹Ÿå™¨ç®¡ç†ç³»ç»Ÿ</p>\
    </div>\
    \
    <div class="container">\
        <div class="card">\
            <h2>ğŸ–¥ï¸ VNCè¿œç¨‹æ¡Œé¢</h2>\
            <p>é€šè¿‡VNCè®¿é—®æ ‘è“æ´¾æ¨¡æ‹Ÿç¯å¢ƒ</p>\
            <iframe src="http://localhost:6080/vnc.html" class="vnc-frame"></iframe>\
        </div>\
        \
        <div class="card">\
            <h2>ğŸ“ ROMæ–‡ä»¶ç®¡ç†</h2>\
            <div class="upload-area" onclick="document.getElementById(\"fileInput\").click()">\
                <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ ROMæ–‡ä»¶</p>\
                <input type="file" id="fileInput" accept=".nes" style="display: none;" onchange="uploadRom()">\
            </div>\
            <div id="romList" class="rom-list"></div>\
        </div>\
        \
        <div class="card">\
            <h2>ğŸ® å¿«é€Ÿæ“ä½œ</h2>\
            <button class="btn" onclick="downloadRoms()">ä¸‹è½½æ¨èROM</button>\
            <button class="btn" onclick="startGame()">å¯åŠ¨æ¸¸æˆé€‰æ‹©å™¨</button>\
            <button class="btn" onclick="restartContainer()">é‡å¯å®¹å™¨</button>\
        </div>\
    </div>\
    \
    <script>\
        // åŠ è½½ROMåˆ—è¡¨\
        function loadRoms() {\
            fetch("/api/roms")\
                .then(response => response.json())\
                .then(roms => {\
                    const romList = document.getElementById("romList");\
                    romList.innerHTML = "";\
                    roms.forEach(rom => {\
                        const romItem = document.createElement("div");\
                        romItem.className = "rom-item";\
                        romItem.innerHTML = `\
                            <h3>${rom.name}</h3>\
                            <p>å¤§å°: ${(rom.size / 1024).toFixed(1)} KB</p>\
                            <p>ä¿®æ”¹æ—¶é—´: ${new Date(rom.modified).toLocaleString()}</p>\
                            <button class="btn btn-danger" onclick="deleteRom(\"${rom.name}\")">åˆ é™¤</button>\
                        `;\
                        romList.appendChild(romItem);\
                    });\
                });\
        }\
        \
        // ä¸Šä¼ ROM\
        function uploadRom() {\
            const fileInput = document.getElementById("fileInput");\
            const file = fileInput.files[0];\
            if (!file) return;\
            \
            const formData = new FormData();\
            formData.append("rom", file);\
            \
            fetch("/api/upload", {\
                method: "POST",\
                body: formData\
            })\
            .then(response => response.json())\
            .then(result => {\
                alert(result.message);\
                loadRoms();\
            })\
            .catch(error => {\
                alert("ä¸Šä¼ å¤±è´¥: " + error.message);\
            });\
        }\
        \
        // åˆ é™¤ROM\
        function deleteRom(filename) {\
            if (!confirm("ç¡®å®šè¦åˆ é™¤ " + filename + " å—ï¼Ÿ")) return;\
            \
            fetch("/api/roms/" + encodeURIComponent(filename), {\
                method: "DELETE"\
            })\
            .then(response => response.json())\
            .then(result => {\
                alert(result.message);\
                loadRoms();\
            });\
        }\
        \
        // ä¸‹è½½æ¨èROM\
        function downloadRoms() {\
            alert("å¼€å§‹ä¸‹è½½æ¨èROMï¼Œè¯·ç¨å€™...");\
            // è¿™é‡Œå¯ä»¥è°ƒç”¨åç«¯APIæ¥è§¦å‘ROMä¸‹è½½\
        }\
        \
        // å¯åŠ¨æ¸¸æˆ\
        function startGame() {\
            alert("å¯åŠ¨æ¸¸æˆé€‰æ‹©å™¨...");\
            // è¿™é‡Œå¯ä»¥è°ƒç”¨åç«¯APIæ¥å¯åŠ¨æ¸¸æˆ\
        }\
        \
        // é‡å¯å®¹å™¨\
        function restartContainer() {\
            if (!confirm("ç¡®å®šè¦é‡å¯å®¹å™¨å—ï¼Ÿ")) return;\
            alert("é‡å¯å®¹å™¨...");\
            // è¿™é‡Œå¯ä»¥è°ƒç”¨åç«¯APIæ¥é‡å¯å®¹å™¨\
        }\
        \
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–\
        document.addEventListener("DOMContentLoaded", () => {\
            loadRoms();\
        });\
    </script>\
</body>\
</html>' > public/index.html

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨å‘½ä»¤
CMD ["npm", "start"]
