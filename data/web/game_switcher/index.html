<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® GamePlayer-Raspberry æ¸¸æˆé€‰æ‹©å™¨</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            font-family: 'Courier New', monospace;
            color: white;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #00ff00;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 30px;
        }
        .status-bar {
            background: rgba(0,0,0,0.5);
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff00;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .game-card {
            background: rgba(0,0,0,0.3);
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .game-card:hover {
            background: rgba(0,255,0,0.1);
            box-shadow: 0 0 20px rgba(0,255,0,0.3);
            transform: translateY(-5px);
        }
        .game-card.playing {
            border-color: #ffff00;
            box-shadow: 0 0 15px rgba(255,255,0,0.5);
        }
        .game-title {
            font-size: 18px;
            font-weight: bold;
            color: #ffff00;
            margin-bottom: 10px;
        }
        .game-info {
            font-size: 14px;
            color: #cccccc;
            margin-bottom: 15px;
        }
        .game-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 8px 16px;
            border: 1px solid #00ff00;
            background: rgba(0,255,0,0.1);
            color: #00ff00;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            font-size: 12px;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
            min-width: 80px;
        }
        .btn:hover {
            background: rgba(0,255,0,0.2);
        }
        .btn-primary {
            background: rgba(0,255,0,0.2);
            color: white;
        }
        .btn-danger {
            border-color: #ff0000;
            color: #ff0000;
            background: rgba(255,0,0,0.1);
        }
        .btn-danger:hover {
            background: rgba(255,0,0,0.2);
        }
        .save-info {
            background: rgba(255,255,0,0.1);
            border: 1px solid #ffff00;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #00ff00;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        .controls {
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }
        .controls h3 {
            color: #00ff00;
            margin-bottom: 15px;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #00ff00;
        }
        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® GamePlayer-Raspberry æ¸¸æˆé€‰æ‹©å™¨</h1>
        
        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator"></div>
                <span>ç³»ç»ŸçŠ¶æ€: <span id="systemStatus">æ­£å¸¸è¿è¡Œ</span></span>
            </div>
            <div class="status-item">
                <span>æ¸¸æˆæ€»æ•°: <span id="gameCount">0</span></span>
            </div>
            <div class="status-item">
                <span>å½“å‰æ¸¸æˆ: <span id="currentGame">æ— </span></span>
            </div>
        </div>
        
        <div id="gameGrid" class="game-grid">
            <div class="loading">æ­£åœ¨åŠ è½½æ¸¸æˆåˆ—è¡¨</div>
        </div>
        
        <div class="controls">
            <h3>ğŸ•¹ï¸ æ§åˆ¶è¯´æ˜</h3>
            <p>â€¢ ç‚¹å‡»"å¼€å§‹æ¸¸æˆ"ç›´æ¥å¯åŠ¨æ¸¸æˆ</p>
            <p>â€¢ ç‚¹å‡»"ç»§ç»­æ¸¸æˆ"åŠ è½½æœ€è¿‘çš„å­˜æ¡£</p>
            <p>â€¢ ç‚¹å‡»"ç®¡ç†å­˜æ¡£"æŸ¥çœ‹æ‰€æœ‰å­˜æ¡£</p>
            <p>â€¢ æ¸¸æˆä¸­æŒ‰ESCé”®è¿”å›é€‰æ‹©ç•Œé¢</p>
            <p>â€¢ æ”¯æŒè‡ªåŠ¨å­˜æ¡£å’Œè¿›åº¦æ¢å¤</p>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let games = [];
        let currentPlayingGame = null;
        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            loadGames();
            setInterval(updateStatus, 5000); // æ¯5ç§’æ›´æ–°çŠ¶æ€
            console.log('ğŸ® GamePlayer-Raspberry æ¸¸æˆé€‰æ‹©å™¨å·²åŠ è½½');
        });
        
        // åŠ è½½æ¸¸æˆåˆ—è¡¨
        async function loadGames() {
            try {
                // å°è¯•ä»APIè·å–æ¸¸æˆåˆ—è¡¨
                const response = await fetch('/api/games');
                if (response.ok) {
                    games = await response.json();
                } else {
                    // å¦‚æœAPIä¸å¯ç”¨ï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®
                    games = getExampleGames();
                }
                
                renderGameGrid();
                updateGameCount();
                
            } catch (error) {
                console.log('ä½¿ç”¨ç¤ºä¾‹æ¸¸æˆæ•°æ®');
                games = getExampleGames();
                renderGameGrid();
                updateGameCount();
            }
        }
        
        // è·å–ç¤ºä¾‹æ¸¸æˆæ•°æ®
        function getExampleGames() {
            return [
                {
                    id: "micro_mages",
                    title: "Micro Mages",
                    description: "ç°ä»£NESå¹³å°æ¸¸æˆæ°ä½œ",
                    category: "å¹³å°æ¸¸æˆ",
                    hasProgress: true,
                    lastPlayed: "2025-06-26 20:30",
                    progress: 65,
                    playTime: "2å°æ—¶15åˆ†é’Ÿ"
                },
                {
                    id: "nova_squirrel",
                    title: "Nova the Squirrel",
                    description: "ç°ä»£å¹³å°å†’é™©æ¸¸æˆ",
                    category: "å†’é™©æ¸¸æˆ",
                    hasProgress: false,
                    lastPlayed: null,
                    progress: 0,
                    playTime: "0åˆ†é’Ÿ"
                },
                {
                    id: "lizard",
                    title: "Lizard",
                    description: "å¤å¤é£æ ¼è§£è°œå¹³å°æ¸¸æˆ",
                    category: "è§£è°œæ¸¸æˆ",
                    hasProgress: true,
                    lastPlayed: "2025-06-25 15:45",
                    progress: 30,
                    playTime: "45åˆ†é’Ÿ"
                },
                {
                    id: "battle_kid",
                    title: "Battle Kid",
                    description: "é«˜éš¾åº¦å¹³å°æ¸¸æˆ",
                    category: "åŠ¨ä½œæ¸¸æˆ",
                    hasProgress: true,
                    lastPlayed: "2025-06-24 10:20",
                    progress: 85,
                    playTime: "3å°æ—¶30åˆ†é’Ÿ"
                },
                {
                    id: "tetris_clone",
                    title: "Tetris Clone",
                    description: "ç»å…¸ä¿„ç½—æ–¯æ–¹å—",
                    category: "ç›Šæ™ºæ¸¸æˆ",
                    hasProgress: false,
                    lastPlayed: null,
                    progress: 0,
                    playTime: "0åˆ†é’Ÿ"
                },
                {
                    id: "space_marine",
                    title: "Space Marine",
                    description: "å¤ªç©ºå°„å‡»æ¸¸æˆ",
                    category: "å°„å‡»æ¸¸æˆ",
                    hasProgress: true,
                    lastPlayed: "2025-06-23 18:00",
                    progress: 50,
                    playTime: "1å°æ—¶20åˆ†é’Ÿ"
                }
            ];
        }
        
        // æ¸²æŸ“æ¸¸æˆç½‘æ ¼
        function renderGameGrid() {
            const gameGrid = document.getElementById('gameGrid');
            gameGrid.innerHTML = '';

            if (games.length === 0) {
                gameGrid.innerHTML = '<div class="loading">æ²¡æœ‰æ‰¾åˆ°æ¸¸æˆæ–‡ä»¶</div>';
                return;
            }

            games.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.className = 'game-card';
                if (game.id === currentPlayingGame) {
                    gameCard.classList.add('playing');
                }
                
                gameCard.innerHTML = `
                    <div class="game-title">${game.title}</div>
                    <div class="game-info">
                        <div>ç±»å‹: ${game.category}</div>
                        <div>${game.description}</div>
                        <div>æ¸¸æˆæ—¶é—´: ${game.playTime}</div>
                    </div>
                    ${game.hasProgress ? `
                        <div class="save-info">
                            ğŸ’¾ è¿›åº¦: ${game.progress}% | æœ€åæ¸¸ç©: ${game.lastPlayed}
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${game.progress}%"></div>
                            </div>
                        </div>
                    ` : ''}
                    <div class="game-actions">
                        <button class="btn btn-primary" onclick="startGame('${game.id}', ${game.hasProgress})">
                            ${game.hasProgress ? 'ç»§ç»­æ¸¸æˆ' : 'å¼€å§‹æ¸¸æˆ'}
                        </button>
                        <button class="btn" onclick="newGame('${game.id}')">æ–°æ¸¸æˆ</button>
                        <button class="btn" onclick="manageSaves('${game.id}')">å­˜æ¡£</button>
                        ${game.id === currentPlayingGame ? 
                            '<button class="btn btn-danger" onclick="stopGame()">åœæ­¢</button>' : ''
                        }
                    </div>
                `;
                
                gameGrid.appendChild(gameCard);
            });
        }
        
        // æ›´æ–°æ¸¸æˆæ•°é‡
        function updateGameCount() {
            document.getElementById('gameCount').textContent = games.length;
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus() {
            // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„çŠ¶æ€æ£€æŸ¥é€»è¾‘
            const statusElement = document.getElementById('systemStatus');
            const currentGameElement = document.getElementById('currentGame');
            
            if (currentPlayingGame) {
                const game = games.find(g => g.id === currentPlayingGame);
                currentGameElement.textContent = game ? game.title : 'æœªçŸ¥æ¸¸æˆ';
            } else {
                currentGameElement.textContent = 'æ— ';
            }
        }
        
        // æ¸¸æˆæ§åˆ¶å‡½æ•°
        async function startGame(gameId, loadSave = false) {
            console.log(`å¯åŠ¨æ¸¸æˆ: ${gameId}, åŠ è½½å­˜æ¡£: ${loadSave}`);
            
            try {
                // å‘é€å¯åŠ¨æ¸¸æˆè¯·æ±‚
                const response = await fetch('/api/start-game', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        gameId: gameId,
                        loadSave: loadSave
                    })
                });
                
                if (response.ok) {
                    currentPlayingGame = gameId;
                    renderGameGrid();
                    showNotification(`æ­£åœ¨å¯åŠ¨ ${getGameTitle(gameId)}...`, 'success');
                } else {
                    showNotification('æ¸¸æˆå¯åŠ¨å¤±è´¥', 'error');
                }
                
            } catch (error) {
                console.error('å¯åŠ¨æ¸¸æˆå¤±è´¥:', error);
                showNotification(`æ¨¡æ‹Ÿå¯åŠ¨ ${getGameTitle(gameId)}...`, 'info');
                currentPlayingGame = gameId;
                renderGameGrid();
            }
        }

        async function newGame(gameId) {
            console.log(`æ–°æ¸¸æˆ: ${gameId}`);
            
            if (confirm('å¼€å§‹æ–°æ¸¸æˆå°†æ¸…é™¤ç°æœ‰å­˜æ¡£ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                try {
                    const response = await fetch('/api/new-game', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ gameId: gameId })
                    });
                    
                    if (response.ok) {
                        currentPlayingGame = gameId;
                        renderGameGrid();
                        showNotification(`æ­£åœ¨å¼€å§‹æ–°æ¸¸æˆ ${getGameTitle(gameId)}...`, 'success');
                    } else {
                        showNotification('æ–°æ¸¸æˆå¯åŠ¨å¤±è´¥', 'error');
                    }
                    
                } catch (error) {
                    console.error('æ–°æ¸¸æˆå¯åŠ¨å¤±è´¥:', error);
                    showNotification(`æ¨¡æ‹Ÿå¼€å§‹æ–°æ¸¸æˆ ${getGameTitle(gameId)}...`, 'info');
                    currentPlayingGame = gameId;
                    renderGameGrid();
                }
            }
        }

        async function manageSaves(gameId) {
            console.log(`ç®¡ç†å­˜æ¡£: ${gameId}`);
            
            try {
                const response = await fetch(`/api/saves/${gameId}`);
                if (response.ok) {
                    const saves = await response.json();
                    showSaveManager(gameId, saves);
                } else {
                    showNotification('æ— æ³•è·å–å­˜æ¡£ä¿¡æ¯', 'error');
                }
                
            } catch (error) {
                console.error('è·å–å­˜æ¡£å¤±è´¥:', error);
                showNotification(`æ‰“å¼€ ${getGameTitle(gameId)} å­˜æ¡£ç®¡ç†...`, 'info');
            }
        }

        async function stopGame() {
            if (currentPlayingGame && confirm('ç¡®å®šè¦åœæ­¢å½“å‰æ¸¸æˆå—ï¼Ÿ')) {
                try {
                    const response = await fetch('/api/stop-game', {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        currentPlayingGame = null;
                        renderGameGrid();
                        showNotification('æ¸¸æˆå·²åœæ­¢', 'success');
                    } else {
                        showNotification('åœæ­¢æ¸¸æˆå¤±è´¥', 'error');
                    }
                    
                } catch (error) {
                    console.error('åœæ­¢æ¸¸æˆå¤±è´¥:', error);
                    currentPlayingGame = null;
                    renderGameGrid();
                    showNotification('æ¸¸æˆå·²åœæ­¢', 'info');
                }
            }
        }
        
        // è¾…åŠ©å‡½æ•°
        function getGameTitle(gameId) {
            const game = games.find(g => g.id === gameId);
            return game ? game.title : gameId;
        }
        
        function showNotification(message, type = 'info') {
            // ç®€å•çš„é€šçŸ¥å®ç°
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#00ff00' : type === 'error' ? '#ff0000' : '#ffff00'};
                color: #000;
                border-radius: 5px;
                z-index: 1000;
                font-family: 'Courier New', monospace;
                font-weight: bold;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }
        
        function showSaveManager(gameId, saves) {
            // ç®€å•çš„å­˜æ¡£ç®¡ç†å™¨å®ç°
            alert(`${getGameTitle(gameId)} å­˜æ¡£ç®¡ç†\n\nè¿™é‡Œå°†æ˜¾ç¤ºå­˜æ¡£åˆ—è¡¨å’Œç®¡ç†é€‰é¡¹`);
        }
    </script>
</body>
</html>
